//国际代号全名
Country_full = {
	AO: "Angola",
	AF: "Afghanistan",
	AL: "Albania",
	DZ: "Algeria",
	AD: "Andorra",
	AI: "Anguilla",
	AG: "Antigua and Barbuda",
	AR: "Argentina",
	AM: "Armenia",
	AU: "Australia",
	AT: "Austria",
	AZ: "Azerbaijan",
	BS: "Bahamas",
	BH: "Bahrain",
	BD: "Bangladesh",
	BB: "Barbados",
	BY: "Belarus",
	BE: "Belgium",
	BZ: "Belize",
	BJ: "Benin",
	BM: "Bermuda Is.",
	BO: "Bolivia",
	BW: "Botswana",
	BR: "Brazil",
	BN: "Brunei",
	BG: "Bulgaria",
	BF: "Burkina-faso",
	MM: "Burma",
	BI: "Burundi",
	CM: "Cameroon",
	CA: "Canada",
	CF: "Central African Republic",
	TD: "Chad",
	CL: "Chile",
	CN: "China",
	CO: "Colombia",
	CG: "Congo",
	CK: "Cook Is.",
	CR: "Costa Rica",
	CU: "Cuba",
	CY: "Cyprus",
	CZ: "Czech Republic",
	DK: "Denmark",
	DJ: "Djibouti",
	DO: "Dominica Rep.",
	EC: "Ecuador",
	EG: "Egypt",
	SV: "EI Salvador",
	EE: "Estonia",
	ET: "Ethiopia",
	FJ: "Fiji",
	FI: "Finland",
	FR: "France",
	GF: "French Guiana",
	GA: "Gabon",
	GM: "Gambia",
	GE: "Georgia",
	DE: "Germany",
	GH: "Ghana",
	GI: "Gibraltar",
	GR: "Greece",
	GD: "Grenada",
	GU: "Guam",
	GT: "Guatemala",
	GN: "Guinea",
	GY: "Guyana",
	HT: "Haiti",
	HN: "Honduras",
	HK: "Hongkong",
	HU: "Hungary",
	IS: "Iceland",
	IN: "India",
	ID: "Indonesia",
	IR: "Iran",
	IQ: "Iraq",
	IE: "Ireland",
	IL: "Israel",
	IT: "Italy",
	JM: "Jamaica",
	JP: "Japan",
	JO: "Jordan",
	KH: "Kingdom of Cambodia",
	KZ: "Kazakstan",
	KE: "Kenya",
	KR: "Korea",
	KW: "Kuwait",
	KG: "Kyrgyzstan",
	LA: "Laos",
	LV: "Latvia",
	LB: "Lebanon",
	LS: "Lesotho",
	LR: "Liberia",
	LY: "Libya",
	LI: "Liechtenstein",
	LT: "Lithuania",
	LU: "Luxembourg",
	MO: "Macao",
	MG: "Madagascar",
	MW: "Malawi",
	MY: "Malaysia",
	MV: "Maldives",
	ML: "Mali",
	MT: "Malta",
	MU: "Mauritius",
	MX: "Mexico",
	MD: "Moldova",
	MC: "Monaco",
	MN: "Mongolia",
	MS: "Montserrat Is",
	MA: "Morocco",
	MZ: "Mozambique",
	NA: "Namibia",
	NR: "Nauru",
	NP: "Nepal",
	NL: "Netherlands",
	NZ: "New Zealand",
	NI: "Nicaragua",
	NE: "Niger",
	NG: "Nigeria",
	KP: "North Korea",
	NO: "Norway",
	OM: "Oman",
	PK: "Pakistan",
	PA: "Panama",
	PG: "Papua New Cuinea",
	PY: "Paraguay",
	PE: "Peru",
	PH: "Philippines",
	PL: "Poland",
	PF: "French Polynesia",
	PT: "Portugal",
	PR: "Puerto Rico",
	QA: "Qatar",
	RO: "Romania",
	RU: "Russia",
	LC: "Saint Lueia",
	VC: "Saint Vincent",
	SM: "San Marino",
	ST: "Sao Tome and Principe",
	SA: "Saudi Arabia",
	SN: "Senegal",
	SC: "Seychelles",
	SL: "Sierra Leone",
	SG: "Singapore",
	SK: "Slovakia",
	SI: "Slovenia",
	SB: "Solomon Is",
	SO: "Somali",
	ZA: "South Africa",
	ES: "Spain",
	LK: "Sri Lanka",
	LC: "St.Lucia",
	VC: "St.Vincent",
	SD: "Sudan",
	SR: "Suriname",
	SZ: "Swaziland",
	SE: "Sweden",
	CH: "Switzerland",
	SY: "Syria",
	TW: "Taiwan",
	TJ: "Tajikstan",
	TZ: "Tanzania",
	TH: "Thailand",
	TG: "Togo",
	TO: "Tonga",
	TT: "Trinidad and Tobago",
	TN: "Tunisia",
	TR: "Turkey",
	TM: "Turkmenistan",
	UG: "Uganda",
	UA: "Ukraine",
	AE: "United Arab Emirates",
	GB: "United Kiongdom",
	US: "United States",
	UY: "Uruguay",
	UZ: "Uzbekistan",
	VE: "Venezuela",
	VN: "Vietnam",
	YE: "Yemen",
	YU: "Yugoslavia",
	ZW: "Zimbabwe",
	ZR: "Zaire",
	ZM: "Zambia",
}
//国家代号对应中文
var CountryCode_CN = {
	AO: "安哥拉",
	AF: "阿富汗",
	AL: "阿尔巴尼亚",
	DZ: "阿尔及利亚",
	AD: "安道尔共和国",
	AI: "安圭拉岛",
	AG: "安提瓜和巴布达",
	AR: "阿根廷",
	AM: "亚美尼亚",
	AU: "澳大利亚",
	AT: "奥地利",
	AZ: "阿塞拜疆",
	BS: "巴哈马",
	BH: "巴林",
	BD: "孟加拉国",
	BB: "巴巴多斯",
	BY: "白俄罗斯",
	BE: "比利时",
	BZ: "伯利兹",
	BJ: "贝宁",
	BM: "百慕大群岛",
	BO: "玻利维亚",
	BW: "博茨瓦纳",
	BR: "巴西",
	BN: "文莱",
	BG: "保加利亚",
	BF: "布基纳法索",
	MM: "缅甸",
	BI: "布隆迪",
	CM: "喀麦隆",
	CA: "加拿大",
	CF: "中非共和国",
	TD: "乍得",
	CL: "智利",
	CN: "中国",
	CO: "哥伦比亚",
	CG: "刚果",
	CK: "库克群岛",
	CR: "哥斯达黎加",
	CU: "古巴",
	CY: "塞浦路斯",
	CZ: "捷克",
	DK: "丹麦",
	DJ: "吉布提",
	DO: "多米尼加共和国",
	EC: "厄瓜多尔",
	EG: "埃及",
	SV: "萨尔瓦多",
	EE: "爱沙尼亚",
	ET: "埃塞俄比亚",
	FJ: "斐济",
	FI: "芬兰",
	FR: "法国",
	GF: "法属圭亚那",
	GA: "加蓬",
	GM: "冈比亚",
	GE: "格鲁吉亚",
	DE: "德国",
	GH: "加纳",
	GI: "直布罗陀",
	GR: "希腊",
	GD: "格林纳达",
	GU: "关岛",
	GT: "危地马拉",
	GN: "几内亚",
	GY: "圭亚那",
	HT: "海地",
	HN: "洪都拉斯",
	HK: "香港",
	HU: "匈牙利",
	IS: "冰岛",
	IN: "印度",
	ID: "印度尼西亚",
	IR: "伊朗",
	IQ: "伊拉克",
	IE: "爱尔兰",
	IL: "以色列",
	IT: "意大利",
	JM: "牙买加",
	JP: "日本",
	JO: "约旦",
	KH: "柬埔寨",
	KZ: "哈萨克斯坦",
	KE: "肯尼亚",
	KR: "韩国",
	KW: "科威特",
	KG: "吉尔吉斯坦",
	LA: "老挝",
	LV: "拉脱维亚",
	LB: "黎巴嫩",
	LS: "莱索托",
	LR: "利比里亚",
	LY: "利比亚",
	LI: "列支敦士登",
	LT: "立陶宛",
	LU: "卢森堡",
	MO: "澳门",
	MG: "马达加斯加",
	MW: "马拉维",
	MY: "马来西亚",
	MV: "马尔代夫",
	ML: "马里",
	MT: "马耳他",
	MU: "毛里求斯",
	MX: "墨西哥",
	MD: "摩尔多瓦",
	MC: "摩纳哥",
	MN: "蒙古",
	MS: "蒙特塞拉特岛",
	MA: "摩洛哥",
	MZ: "莫桑比克",
	NA: "纳米比亚",
	NR: "瑙鲁",
	NP: "尼泊尔",
	NL: "荷兰",
	NZ: "新西兰",
	NI: "尼加拉瓜",
	NE: "尼日尔",
	NG: "尼日利亚",
	KP: "朝鲜",
	NO: "挪威",
	OM: "阿曼",
	PK: "巴基斯坦",
	PA: "巴拿马",
	PG: "巴布亚新几内亚",
	PY: "巴拉圭",
	PE: "秘鲁",
	PH: "菲律宾",
	PL: "波兰",
	PF: "法属玻利尼西亚",
	PT: "葡萄牙",
	PR: "波多黎各",
	QA: "卡塔尔",
	RO: "罗马尼亚",
	RU: "俄罗斯",
	LC: "圣卢西亚",
	VC: "圣文森特岛",
	SM: "圣马力诺",
	ST: "圣多美和普林西比",
	SA: "沙特阿拉伯",
	SN: "塞内加尔",
	SC: "塞舌尔",
	SL: "塞拉利昂",
	SG: "新加坡",
	SK: "斯洛伐克",
	SI: "斯洛文尼亚",
	SB: "所罗门群岛",
	SO: "索马里",
	ZA: "南非",
	ES: "西班牙",
	LK: "斯里兰卡",
	LC: "圣卢西亚",
	VC: "圣文森特",
	SD: "苏丹",
	SR: "苏里南",
	SZ: "斯威士兰",
	SE: "瑞典",
	CH: "瑞士",
	SY: "叙利亚",
	TW: "台湾省",
	TJ: "塔吉克斯坦",
	TZ: "坦桑尼亚",
	TH: "泰国",
	TG: "多哥",
	TO: "汤加",
	TT: "特立尼达和多巴哥",
	TN: "突尼斯",
	TR: "土耳其",
	TM: "土库曼斯坦",
	UG: "乌干达",
	UA: "乌克兰",
	AE: "阿拉伯联合酋长国",
	GB: "英国",
	US: "美国",
	UY: "乌拉圭",
	UZ: "乌兹别克斯坦",
	VE: "委内瑞拉",
	VN: "越南",
	YE: "也门",
	YU: "南斯拉夫",
	ZW: "津巴布韦",
	ZR: "扎伊尔",
	ZM: "赞比亚"
};

/* 这里试图获取eBay的地址信息 */
chrome.runtime.onMessage.addListener(function(request, sender, sendResponse) {
	//处理事件在这里
	if (request.method == "getSelection") {
		//获取页面标题
		var titlestr = (document.title == "") ? "{{int:无标题见识}}" : document.title; //检测是否为空一起都在这里
		var copystr = "[!无地址信息]"; //默认地址信息？
		copystr = ebay_GetAddress(); // 获取回来地址信息

		//遣送回去数据
		sendResponse({
			data: copystr,
			title: titlestr,
			url: window.location.href,
			copy_type: {
				type: "ink_slboat"
			} //使用航海见识的类型，只有一个基本内容。
		});
	} else
		return false;
});

function ebay_GetAddress() {
	/* 常量 */
	var ext_note = true; //额外信息
	/* 用量 */
	var address, phone; //最终的地址构成部分
	var code, code_full; //临时的code
	var info_add; //最终的地址
	//第一部分，只是地址信息
	address = ""; //初始化？
	if (ext_note) address += "[Address]"; //初始化字串，不要的选择？

	//过滤大空格，再次过滤多换行
	address += $("#shippingAddress").text().replace(/	/g, "").replace(/\n\n/g, "\n");

	/* 处理国家缩写名 */
	code = str_getLastline(address);
	if (is_vaild_Country_Code(code)) {
		code_full = eBay_TranCountryCode(code);
		if (code_full) { //考虑到空字串为假，这里很可能是可靠的
			$("#shippingAddress").html($("#shippingAddress").html().replace("	" + code + "\n", "	" + code + " [" + code_full + "]" + "\n"))
		}
	}
	/* 电话信息处理 */
	//构建电话信息的
	phone = $("#shippingAddressPhoneNum").text(); //进行两次替换-由于两种不同的空格头长度
	if (phone.trim() == "Phone number") //检查只有电话号码字样
	{
		phone = ""; //清理掉所有？
	}
	//TODO:也处理多换行？
	phone = phone.replace(/	/g, "").replace(/    /g, "");

	//电话的递加
	if (ext_note) phone = phone.replace("Phone number", "[Phone number]");

	//叠加-有点罗嗦
	info_add = address + phone; //叠加起来

	//最后的事情
	info_add = info_add.replace(/\n$/, ""); //切除末尾的换行，如果需要的话

	return info_add; //抛出返回信息
}

/* 检查国家代码是否有效 */

function is_vaild_Country_Code(code) {
	return (code.length == 2 && (code.match(/[A-Z]{2}/)))
}

/* 转义国家代码
 * 如果转义失败，返回空白
 */

function eBay_TranCountryCode(code) {
	if (typeof(code) == "string" && code.length == 2) {
		if (CountryCode_CN[code]) {
			//返回全名+中文
			return Country_full[code] + ":" + CountryCode_CN[code]; //返回国家咯
		}
	}
	return ""
}

/* 字符串部件：获得最后一行 
 * 如果啥也获得不了，那就返回空字串
 */

function str_getLastline(str) {
	//切割开始
	var tmpStrArr = $.trim(str).split("\n"); //修理头尾空白-再开始？
	if (tmpStrArr.length > 1) { //如果至少有一行
		//返回最后一行
		return tmpStrArr[tmpStrArr.length - 1];
	}
	return ""
}